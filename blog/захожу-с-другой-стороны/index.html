<!DOCTYPE html>
<html lang="ru-RU">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="Don&#39;t panic">

<base href="https://platoff.github.io/">
<title>


     Захожу с другой стороны 

</title>
<link rel="canonical" href="https://platoff.github.io/blog/%D0%B7%D0%B0%D1%85%D0%BE%D0%B6%D1%83-%D1%81-%D0%B4%D1%80%D1%83%D0%B3%D0%BE%D0%B9-%D1%81%D1%82%D0%BE%D1%80%D0%BE%D0%BD%D1%8B/">








<link rel="stylesheet" href="https://platoff.github.io/css/reset.css">
<link rel="stylesheet" href="https://platoff.github.io/css/pygments.css">
<link rel="stylesheet" href="https://platoff.github.io/css/main.css">


    <link rel="stylesheet" href="https://platoff.github.io/css/override.css">



<link rel="shortcut icon"

    href="https://platoff.github.io/img/leaf.ico"

>






</head>


<body lang="ru">

<section class="header"> 
    <div class="container">
        <div class="content">
            
              <a href="https://platoff.github.io/"><img class="avatar" src="https://platoff.github.io/img/avatar.jpg" /></a>
            
            <a href="https://platoff.github.io/"><div class="name">Андрей Платов</div></a>
            <nav>
                <ul>
                    <a href="https://platoff.github.io/blog/"><li>Журнал</li></a>
                    <a href="https://platoff.github.io/about/"><li>Обо мне</li></a>
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">

        
            <a href="//github.com/platoff" target="_blank">
                <i class="icon ion-social-github"></i>
            </a>
        
        
        
            <a href="//twitter.com/platoff" target="_blank">
                <i class="icon ion-social-twitter"></i>
            </a>
        

        
            <a href="//linkedin.com/in/platov" target="_blank">
                <i class="icon ion-social-linkedin"></i>
            </a>
        

        

        

        
            <a href="mailto:andrey@xored.com">
                <i class="icon ion-ios-email larger"></i>
            </a>
        

        
            <a href="https://platoff.github.io/index.xml">
                <i class="icon ion-social-rss larger"></i>
            </a>
        
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    Захожу с другой стороны

</div>

                    <div class="initials"><a href="https://platoff.github.io/"></a></div>
                </div>
                <div class="meta">
                    <div class="date" title="Mon Jan 2 2017 10:19:40 CET">Jan 2, 2017</div>
                    <div class="reading-time"><div class="middot"></div>6 minutes read</div>
                </div>
            </div>
            <div class="markdown">
                

<p>Итак, 2 января 2017го. Декабрьская поездка в Прагу и Новосибирск поломала только начинавшеюся практику ежедневного программирования, суета конца года в бизнесе усугубила, но пару дней в конце года я уделил для кода.</p>

<p>Что я имею: какой то жалкий прототип dom diff &ndash; это даже нельзя назвать virtual dom, поскольку DOM как таковой у меня отсутствует (даже виртуальный). Чтобы двинуться дальше надо увидеть всю картину, поэтому я зайду с другой стороны - со стороны модели.</p>

<p>Я - старый фанат <a href="http://www.datomic.com">datomic</a>. Настолько старый, что вы не поверите, но что не удивительно, учитывая мой вечный, берущий начало в прошлом веке интерес к архтектурам БД, и чему есть <a href="https://twitter.com/platoff/statuses/281250841401389056">документальные подтверждения из 2012-го</a>.</p>

<p>Несколько лет назад <a href="http://tonsky.me">Никита Прокопов</a> сделал довольно известное в некоторых кругах архитектурное подобие Datomic под названием <a href="https://github.com/tonsky/datascript">DataScript</a>, а буквально месяц назад кто-то твитнул о том что Mozilla тоже делает нечно похожее. Вот оно: <a href="https://github.com/mozilla/datomish">Datomish</a>.</p>

<p>В каком направлении идет Mozilla я не смотрел, но пару лет назад встречался с Никитой и говорил что для платформы моей мечты я хочу сделать полноценный datomic на стороне браузера. Тогда Никита сказал что это пиздец и на такое не готов сам Rich Hickey (не знаю поменял Никита свою точку зрения к этому моменту или нет), но тогда он подкинул мне интересных ребят, и хоть я на них уже натыкался, ребят стоит читать и внимательно смотреть - они очень интересные, спасибо Никите. Вот ребята: <a href="http://witheve.com">Eve: Programming designed for humans</a>&hellip; Нашел письмо от Никиты, встречались мы в октябре 2014го.</p>

<p>В общем я не буду ждать ни Никиту ни Mozilla, а просто попытаюсь сделать для себя полноценный Datomic-alike database, с клиентом (peer, в терминологии datomic) на стороне браузера. Задача эта интересна еще и тем, что с 2000-х годов в мире возникло столько структур данных и алгоритмов, что прям крышу сносит. Это в основном succint и cache-oblivious data structures, который интересно было бы с большой пользой применить в БД.</p>

<p>Но начну я с очень простой, скажем так, схематичной реализации хранилища и выполнения запросов.</p>

<h1 id="прототип">Прототип</h1>

<p>В моем прототипе основная часть &ndash; это выполнение запросов. В своей прошлой жизни я никогда до этого момента не доходил (выполнение любого запроса от пользователя). Ибо, если ты делаешь какое то свое хранилище вместо БД общего назначения &ndash; то оно <em>специализированное</em> под конкретную задачу. Это имеет смысл, поскольку в этом случае ты имеешь шанс уделать любую базу данных общего назначения (по памяти, производительности и т.д.). Это предполагает и выполнение конкретных запросов супротив оптимизированной структуры.</p>

<p>Но жизнь показывает, что большинство программистов мыслят стереотипом: если есть данные и есть запросы к данным надо взять БД. Вы не поверите насколько много программистов так мыслят, и даже очень хороших. Работал у нас один мужчина - очень неплохой, и в какой-то момент он занимался эксклюзивно <a href="http://eclipse.org/dltk">DLTK</a>. DLTK это грубо говоря средство разработки, а в средстве разработке задача поиска разнообразной информации - вещь необходимая. Так вот: этот программист всандалил туда <a href="http://www.h2database.com/html/main.html">H2 Database</a>, чем вызвал мое полное недоумение и неприязнь.</p>

<p>Ладно бы он засунул какую-нить BerkeleyDB, но полнценную, реляционную БД с SQL фронт-эндом &ndash; это полный пиздец. А больший пиздец в том, что это <a href="http://spektom.blogspot.fr/2009/07/new-dltk-indexing-is-promising.html">мало кого удивило</a> за исключением реально думащих чуваков, как, например известный в мире PHP Seva (Wsevolod) Lapsha, который буквально снял мои слова с языка:</p>

<pre><code>As I already mentioned, you would probably like to try the Berkeley DB. I assume you do not use non-trivial table joints and filtering, in the queries, so seemless Map interface provided by Berkeley would be easier to use. Also the statement parsing, compilation and optimization is told to be a certain overhead.
Anyway, it would be interesting to perform a clean performance comparison between H2 and B., since I did not found an existing one over the Internets.
</code></pre>

<p>Я не знаю выпилили ли они H2 из DLTK на данный момент (хоть я вроде и оставался формальным Project Lead этого проекта долгое время), но беглый поиск по сети говорит что <a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=454867">еблись ребята долго</a>.</p>

<p>Но мы не ищем легких путей (сарказм), хотя можно было бы сейчас скомпилячить <code>sqllite</code> emscripten-ом и подрачить на то, что у меня уже есть БД в браузере, рассазать вам что у меня есть реляционная &ldquo;альтернатива&rdquo; datomic, настроить хуеты вокруг и жидко обосраться в конце.</p>

<h1 id="что-есть-на-данный-момент">Что есть на данный момент</h1>

<p>Практически нихуя. Как я писал выше, моя первая задача - выполнить запрос. В архитектуре datomic любой запрос - это большое количество джойнов, про архитектуру, если не хотите рыться в сети можно почитать выжимку у Никиты: <a href="http://tonsky.me/blog/unofficial-guide-to-datomic-internals/">Unofficial guide to Datomic internals</a>.</p>

<p>Поскольку я интересуюсь БД давно то есть у меня в загашнике знание об одном замечательном алгоритме, который называется <a href="https://arxiv.org/abs/1210.0481">Leapfrog Triejoin</a>. Его я и попользую, поскольку 1) реализация алгоритма тривиальна 2) есть подозрение что он будет работать быстрее чем у Никиты, а у него в DataScript, как я понимаю из <a href="http://tonsky.me/blog/datascript-internals/">A shallow dive into DataScript internals</a> Hash Join.</p>

<h1 id="новый-репозиторий">Новый репозиторий</h1>

<p>Самое время во второй день нового года сделать новую репу, и залить туда всю гавнину. Тем более что старая <a href="https://github.com/platoff/faxma">faxma</a> уже неактуальна ни своим названием /blog/virtual-dom-%D0%B4%D0%B5%D0%BD%D1%8C-2/ ни сутью. Вот оно: <a href="https://github.com/platoff/wafer">https://github.com/platoff/wafer</a>. Web Application Framework (Elegant and Reactive).</p>

<p><code>leapfrog.nim</code> реализация Leapfrog Triejoin. <code>rel.nim</code> простое хранилище отношений. Отношение это набор tuples вида <code>[a b c ...]</code>, и я предполгаю что все переменные в тупле фиксированной длинны, за исключением одной, которая может быть переменной длинны (этого допущения мне явно не хватит, но пусть пока так).</p>

<p><code>db.nim</code> &ndash; не законченная реализация запросов (из данных, лежащих в rel с помощью leapfrog). Поскольку leapfrog все за меня делает, мне остается лишь построить какой-то план выполнения запроса, итераторы соответствующие этому плану и отдать все это дело в leapfrog. План запроса - не что иное как порядок вычисления переменных участвующих в запросе. Я мог бы сейчас взять их в любом порядке, но хочется посмотреть как согласуются части программы, поэтому я все же делаю какой-то алгоритм выбора эффективного плана (который, в силу своей примитивности, легко сможет &ldquo;выбрать&rdquo; хуевый план).</p>

<h1 id="хуярю">Хуярю</h1>

<p>Надо доделать сам join, сейчас у меня есть только план выполнения запроса. Но перед этим надо навести порядок с ебучей матрицей, которая у меня вдруг возникла. Последний раз я матрицу пользовал в школе, когда программировал пиксельную графику (и не для афинных преобразований &ndash; я про них не знал ни тогда ни сейчас), а для того чтобы хранить пиксели. А из университета меня выгнали, так что матрицы я не программировал, и всегда считал что для программиста достаточно одномерного массива. Но все же в данном месте мне очень хочется ее засунуть.</p>

<p>&hellip;В общем хер с ним &ndash; делать полноценное построение всех планов это подзаебаться, завтра сделаю чтобы работало в моих частных случаях. <a href="https://github.com/platoff/wafer/commit/4bd155da9c37fa54cfeaad4ac5dce8d97d821371">Коммит</a></p>

                <br>
                <p><a href="https://platoff.github.io/blog/">Назад, к записям</a></p>
            </div>
            <br>
            <div class="disqus">
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'platoff';
    var disqus_identifier = 'https:\/\/platoff.github.io\/blog\/%D0%B7%D0%B0%D1%85%D0%BE%D0%B6%D1%83-%D1%81-%D0%B4%D1%80%D1%83%D0%B3%D0%BE%D0%B9-%D1%81%D1%82%D0%BE%D1%80%D0%BE%D0%BD%D1%8B\/';
    var disqus_title = 'Захожу с другой стороны';
    var disqus_url = 'https:\/\/platoff.github.io\/blog\/%D0%B7%D0%B0%D1%85%D0%BE%D0%B6%D1%83-%D1%81-%D0%B4%D1%80%D1%83%D0%B3%D0%BE%D0%B9-%D1%81%D1%82%D0%BE%D1%80%D0%BE%D0%BD%D1%8B\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
        </div>
    </div>
</section>







</body>
</html>

